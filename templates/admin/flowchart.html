
{% extends "admin/base.html" %}

{% block title %}Mapa de Fluxo - Administração{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="card-title">Mapa de Fluxo da História</h2>
                    <div class="btn-group">
                        <button class="btn btn-primary" id="zoomIn"><i class="bi bi-zoom-in"></i></button>
                        <button class="btn btn-primary" id="zoomOut"><i class="bi bi-zoom-out"></i></button>
                        <button class="btn btn-primary" id="resetZoom"><i class="bi bi-arrows-angle-expand"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header bg-dark">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-white">Visualização do Fluxo</h5>
            <div class="btn-group">
                <button class="btn btn-outline-light btn-sm" onclick="toggleNodes('battle')">Batalhas</button>
                <button class="btn btn-outline-light btn-sm" onclick="toggleNodes('choice')">Escolhas</button>
                <button class="btn btn-outline-light btn-sm" onclick="toggleNodes('end')">Finais</button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div id="flowchart" class="mermaid"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
    mermaid.initialize({ 
        startOnLoad: true,
        theme: 'dark',
        flowchart: {
            curve: 'basis',
            defaultRenderer: 'elk'
        }
    });

    let currentScale = 1;
    const flowchart = document.getElementById('flowchart');
    
    document.getElementById('zoomIn').onclick = () => {
        currentScale *= 1.2;
        flowchart.style.transform = `scale(${currentScale})`;
    };
    
    document.getElementById('zoomOut').onclick = () => {
        currentScale *= 0.8;
        flowchart.style.transform = `scale(${currentScale})`;
    };
    
    document.getElementById('resetZoom').onclick = () => {
        currentScale = 1;
        flowchart.style.transform = `scale(${currentScale})`;
    };

    function generateFlowchart() {
        let nodes = {{ nodes|tojson|safe }};
        let flowDef = ['flowchart TB'];
        
        for (let [nodeId, node] of Object.entries(nodes)) {
            let style = '';
            if (node.battle) {
                style = ':::battle';
            } else if (node.end) {
                style = ':::end';
            } else if (node.choices) {
                style = ':::choice';
            }
            
            flowDef.push(`    ${nodeId}["${nodeId}"]${style}`);
            
            if (node.choices) {
                node.choices.forEach((choice, idx) => {
                    let targetNode = choice.next_node || choice.success_node;
                    if (targetNode) {
                        flowDef.push(`    ${nodeId} -->|"${choice.text.substring(0, 20)}${choice.text.length > 20 ? '...' : ''}"| ${targetNode}`);
                    }
                    if (choice.failure_node) {
                        flowDef.push(`    ${nodeId} -->|"Falha"| ${choice.failure_node}`);
                    }
                });
            }
            if (node.next_node) {
                flowDef.push(`    ${nodeId} --> ${node.next_node}`);
            }
            if (node.victory_node) {
                flowDef.push(`    ${nodeId} -->|"Vitória"| ${node.victory_node}`);
            }
            if (node.defeat_node) {
                flowDef.push(`    ${nodeId} -->|"Derrota"| ${node.defeat_node}`);
            }
        }
        
        flowDef.push('    classDef battle fill:#ff6b6b,stroke:#ff6b6b');
        flowDef.push('    classDef end fill:#51cf66,stroke:#51cf66');
        flowDef.push('    classDef choice fill:#339af0,stroke:#339af0');
        
        return flowDef.join('\n');
    }

    document.addEventListener('DOMContentLoaded', function() {
        const flowchartDiv = document.getElementById('flowchart');
        flowchartDiv.textContent = generateFlowchart();
    });

    function toggleNodes(type) {
        const nodes = document.querySelectorAll(`.${type}`);
        nodes.forEach(node => {
            node.style.display = node.style.display === 'none' ? 'block' : 'none';
        });
    }
</script>

<style>
    #flowchart {
        width: 100%;
        min-height: 800px;
        transform-origin: top left;
        transition: transform 0.2s;
    }
    
    .mermaid {
        overflow: auto;
    }
</style>
{% endblock %}
