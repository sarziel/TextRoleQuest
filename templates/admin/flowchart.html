
{% extends "admin/base.html" %}

{% block title %}Mapa de Fluxo - Administração{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="card-title">Mapa de Fluxo da História</h2>
                    <div class="btn-group">
                        <button class="btn btn-primary" id="zoomIn"><i class="bi bi-zoom-in"></i></button>
                        <button class="btn btn-primary" id="zoomOut"><i class="bi bi-zoom-out"></i></button>
                        <button class="btn btn-primary" id="resetZoom"><i class="bi bi-arrows-angle-expand"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header bg-dark">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-white">Visualização do Fluxo</h5>
            <div class="btn-group">
                <button class="btn btn-outline-light btn-sm active" onclick="toggleNodes('all')">Todos</button>
                <button class="btn btn-outline-light btn-sm" onclick="toggleNodes('battle')">Batalhas</button>
                <button class="btn btn-outline-light btn-sm" onclick="toggleNodes('choice')">Escolhas</button>
                <button class="btn btn-outline-light btn-sm" onclick="toggleNodes('end')">Finais</button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div id="flowchart" class="mermaid"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
    mermaid.initialize({ 
        startOnLoad: true,
        theme: 'dark',
        flowchart: {
            curve: 'basis',
            htmlLabels: true,
            nodeSpacing: 50,
            rankSpacing: 50,
            padding: 10
        }
    });

    let currentScale = 1;
    const flowchart = document.getElementById('flowchart');
    
    document.getElementById('zoomIn').onclick = () => {
        currentScale *= 1.2;
        flowchart.style.transform = `scale(${currentScale})`;
    };
    
    document.getElementById('zoomOut').onclick = () => {
        currentScale *= 0.8;
        flowchart.style.transform = `scale(${currentScale})`;
    };
    
    document.getElementById('resetZoom').onclick = () => {
        currentScale = 1;
        flowchart.style.transform = `scale(${currentScale})`;
    };

    function generateFlowchart() {
        let nodes = {{ nodes|tojson|safe }};
        let flowDef = ['graph TD'];
        
        // Definir estilos
        flowDef.push('    classDef battle fill:#ff6b6b,stroke:#ff6b6b,color:#fff');
        flowDef.push('    classDef end fill:#51cf66,stroke:#51cf66,color:#fff');
        flowDef.push('    classDef choice fill:#339af0,stroke:#339af0,color:#fff');
        flowDef.push('    classDef default fill:#495057,stroke:#495057,color:#fff');
        
        // Adicionar nós
        for (let [nodeId, node] of Object.entries(nodes)) {
            let nodeClass = '';
            let safeNodeId = nodeId.replace(/[^a-zA-Z0-9]/g, '_');
            let nodeTitle = node.title ? 
                `${safeNodeId}["${nodeId.replace(/"/g, "'")}<br>${node.title.replace(/"/g, "'")}"]` : 
                `${safeNodeId}["${nodeId.replace(/"/g, "'")}"]`;
            
            if (node.battle) nodeClass = ':::battle';
            else if (node.end) nodeClass = ':::end';
            else if (node.choices) nodeClass = ':::choice';
            
            flowDef.push(`    ${nodeTitle}${nodeClass}`);
            
            // Adicionar conexões
            if (node.choices) {
                node.choices.forEach((choice, idx) => {
                    let targetNode = choice.next_node || choice.success_node;
                    if (targetNode) {
                        let safeTargetId = targetNode.replace(/[^a-zA-Z0-9]/g, '_');
                        let choiceText = choice.text.substring(0, 20).replace(/"/g, "'") + 
                            (choice.text.length > 20 ? '...' : '');
                        flowDef.push(`    ${safeNodeId} -->|"${choiceText}"| ${safeTargetId}`);
                    }
                    if (choice.failure_node) {
                        let safeFailureId = choice.failure_node.replace(/[^a-zA-Z0-9]/g, '_');
                        flowDef.push(`    ${safeNodeId} -->|"Falha"| ${safeFailureId}`);
                    }
                });
            }
            if (node.next_node) {
                let safeNextId = node.next_node.replace(/[^a-zA-Z0-9]/g, '_');
                flowDef.push(`    ${safeNodeId} --> ${safeNextId}`);
            }
            if (node.victory_node) {
                let safeVictoryId = node.victory_node.replace(/[^a-zA-Z0-9]/g, '_');
                flowDef.push(`    ${safeNodeId} -->|"Vitória"| ${safeVictoryId}`);
            }
            if (node.defeat_node) {
                let safeDefeatId = node.defeat_node.replace(/[^a-zA-Z0-9]/g, '_');
                flowDef.push(`    ${safeNodeId} -->|"Derrota"| ${safeDefeatId}`);
            }
        }
        
        return flowDef.join('\n');
    }

    function toggleNodes(type) {
        const diagram = document.querySelector('.mermaid');
        let nodes = diagram.querySelectorAll('g.node');
        
        nodes.forEach(node => {
            if (type === 'all') {
                node.style.display = 'block';
                return;
            }
            
            let nodeClass = node.getAttribute('class');
            if (type === 'battle' && nodeClass.includes('battle')) {
                node.style.display = node.style.display === 'none' ? 'block' : 'none';
            } else if (type === 'choice' && nodeClass.includes('choice')) {
                node.style.display = node.style.display === 'none' ? 'block' : 'none';
            } else if (type === 'end' && nodeClass.includes('end')) {
                node.style.display = node.style.display === 'none' ? 'block' : 'none';
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const flowchartDiv = document.getElementById('flowchart');
        flowchartDiv.textContent = generateFlowchart();
    });
</script>

<style>
    #flowchart {
        width: 100%;
        min-height: 800px;
        transform-origin: top left;
        transition: transform 0.2s;
        overflow: auto;
    }
    
    .mermaid {
        background: #212529;
        padding: 20px;
        border-radius: 8px;
    }

    .btn-group .btn.active {
        background-color: #fff;
        color: #212529;
    }
</style>
{% endblock %}
